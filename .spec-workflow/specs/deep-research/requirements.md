# 需求文档：深度研究扩展

## 简介

本功能为 Sisyphus Claude 插件添加**深度研究能力**，使其能够从互联网多平台（新闻、论文、社交媒体等）收集、处理、存储和分析信息，最终生成结构化研究报告。

**核心价值**：
- 将 Sisyphus 从代码开发助手扩展为全能研究助手
- 复用现有的智能体编排框架，降低开发成本
- 提供统一的研究工作流，支持多种研究场景

## 与产品愿景的对齐

本扩展与 Sisyphus 的核心理念一致：
> "像西西弗斯一样，这些智能体坚持到每项任务完成"

深度研究任务通常需要：
- 多步骤迭代（搜索 → 爬取 → **聚合** → 分析 → 深化）
- 多智能体协作（规划、执行、聚合、综合）
- 持久化和恢复能力

这些正是 Sisyphus 框架的核心优势。

---

## 功能需求

### 需求 1：深度研究技能 (/deep-research)

**用户故事**：作为研究人员，我想通过一个命令启动深度研究任务，以便快速收集和分析特定主题的信息。

#### 验收标准

1. 当用户输入 `/deep-research <主题>` 时，系统应启动研究工作流
2. 当研究启动时，系统应自动分解研究问题为子查询
3. 当子查询生成完成时，系统应并行执行多源搜索
4. 若搜索结果不足，系统应自动扩展搜索范围或深化查询
5. 当信息收集完成时，系统应生成结构化研究报告

---

### 需求 2：爬虫工具矩阵

**用户故事**：作为研究人员，我想根据数据源类型自动选择合适的爬虫工具，以便高效获取不同平台的内容。

#### 验收标准

1. 当目标为通用网页时，系统应使用 Exa/Tavily 搜索
2. 当目标为中文社交媒体时，系统应调用 MediaCrawler
3. 当目标为新闻/公众号时，系统应调用 NewsCrawler
4. 当目标为学术论文时，系统应调用 Semantic Scholar API
5. 若用户指定特定平台，系统应优先使用指定的爬虫工具

---

### 需求 3：研究资料存储

**用户故事**：作为研究人员，我想将收集的资料持久化存储，以便后续检索和复用。

#### 验收标准

1. 当资料收集完成时，系统应保存为 Markdown 格式
2. 当资料保存时，系统应同时更新 SQLite 元数据索引
3. 若启用向量检索，系统应生成并存储 embedding
4. 当用户查询历史资料时，系统应支持关键词和语义检索
5. 若配置了 Google Drive，系统应支持云端同步

---

### 需求 4：信息聚合

**用户故事**：作为研究人员，我想将多源收集的信息进行智能聚合，以便消除重复、融合观点、形成结构化知识。

#### 验收标准

1. 当多源搜索完成时，系统应对结果进行去重处理
2. 当检测到相似内容时，系统应合并并标注来源
3. 当聚合完成时，系统应按主题/时间/相关性进行排序
4. 系统应提取关键实体、观点和关系
5. 系统应生成聚合摘要，标注信息覆盖度和置信度

#### 聚合策略

| 聚合类型 | 说明 | 适用场景 |
|----------|------|----------|
| 去重聚合 | SimHash/MinHash 相似度检测 | 新闻追踪 |
| 观点聚合 | 提取并归类不同观点 | 舆情分析 |
| 时序聚合 | 按时间线整理事件发展 | 事件追踪 |
| 实体聚合 | 围绕核心实体组织信息 | 竞品调研 |
| 引用聚合 | 构建引用关系网络 | 学术综述 |

---

### 需求 5：研究员智能体

**用户故事**：作为用户，我想有一个专门的研究智能体来协调整个研究流程，以便获得高质量的研究结果。

#### 验收标准

1. 当研究任务启动时，研究员智能体应制定研究策略
2. 当策略制定完成时，研究员应协调其他智能体执行
3. 当信息收集完成时，研究员应进行分析和综合
4. 若研究深度不足，研究员应触发迭代深化
5. 当研究完成时，研究员应生成最终报告

---

### 需求 6：基于 Sisyphus 的任务编排

**用户故事**：作为研究人员，我想复用 Sisyphus 框架的任务管理机制，以便获得可靠的任务拆解、编排、验收和迭代能力。

#### 6.1 任务拆解（TodoWrite 集成）

**验收标准**：
1. 当研究主题输入时，系统应使用 TodoWrite 创建子任务树
2. 每个子任务应标注状态：pending / in_progress / completed
3. 同一时间只能有一个任务处于 in_progress 状态
4. 任务完成后应立即标记 completed（不批量处理）

#### 6.2 智能体委托（Orchestrator 模式）

**验收标准**：
1. 研究协调者应采用 Orchestrator 模式：只协调不执行
2. 独立子任务应并行委托给专业智能体
3. 每次委托必须包含：TASK / EXPECTED OUTCOME / CONTEXT
4. 委托结果应通过 Read/Bash 工具验证

**智能体路由表**：

| 研究任务类型 | 委托智能体 | 模型 |
|-------------|-----------|------|
| 搜索策略制定 | metis | Opus |
| 多源信息搜索 | librarian | Sonnet |
| 快速内容扫描 | explore | Haiku |
| 深度内容分析 | oracle | Opus |
| 报告撰写 | document-writer | Haiku |
| 研究计划审核 | momus | Opus |

#### 6.3 强制验收（Ralph Loop 机制）

**验收标准**：
1. 研究任务应支持 Ralph Loop 模式（`/deep-research --ralph`）
2. 启用后，只有输出 `<promise>DONE</promise>` 才能结束
3. 结束前必须通过 Oracle 验证
4. 未完成时自动续行，不允许提前退出

**Oracle 验证清单**：
- [ ] 所有子任务标记为 completed
- [ ] 研究问题已完整回答
- [ ] 信息来源多样且可靠
- [ ] 报告结构清晰完整
- [ ] 无明显遗漏或错误

#### 6.4 动态调整

**验收标准**：
1. 当子任务结果不足时，系统应自动添加补充任务
2. 当发现新线索时，系统应动态扩展任务树
3. 用户可中途调整研究方向，系统应重新规划
4. 支持广度优先/深度优先/并行执行三种编排模式

#### 6.5 技能组合

**验收标准**：
1. `/deep-research` 应作为执行层技能
2. **默认启用** `ultrawork`（并行加速）+ `ralph-loop`（强制完成）
3. 可通过参数禁用：`--no-ultrawork` / `--no-ralph`
4. 示例：
   - `/deep-research AI芯片市场` → 默认启用 ultrawork + ralph
   - `/deep-research AI芯片市场 --no-ralph` → 仅启用 ultrawork
   - `/deep-research AI芯片市场 --quick` → 快速模式，禁用两者

---

### 需求 7：研究任务检测钩子

**用户故事**：作为用户，我想系统能自动识别研究类任务，以便自动激活研究工作流。

#### 验收标准

1. 当用户输入包含研究关键词时，系统应建议使用 /deep-research
2. 若用户确认，系统应自动切换到研究模式
3. 当研究中断时，系统应保存进度以便恢复

---

### 需求 8：插件组件扩展

**用户故事**：作为 Sisyphus 用户，我想通过标准插件结构获得深度研究能力，以便无缝集成到现有工作流。

#### 8.1 新增 Agents（3个）

| Agent | 文件 | 模型 | 职责 |
|-------|------|------|------|
| **researcher** | `agents/researcher.md` | Opus | 研究协调者：制定策略、分解问题、综合分析、生成报告 |
| **crawler-coordinator** | `agents/crawler-coordinator.md` | Sonnet | 爬虫调度：选择工具、并行获取、结果聚合 |
| **knowledge-manager** | `agents/knowledge-manager.md` | Haiku | 知识管理：存储索引、去重、检索、归档 |

#### 8.2 新增 Skills（1个）

| Skill | 目录 | 说明 |
|-------|------|------|
| **deep-research** | `skills/deep-research/SKILL.md` | 深度研究技能，默认启用 ultrawork + ralph-loop |

#### 8.3 新增 Commands（3个）

| Command | 文件 | 说明 |
|---------|------|------|
| `/deep-research <主题>` | `commands/deep-research.md` | 启动深度研究任务 |
| `/crawl <URL/平台>` | `commands/crawl.md` | 单独爬取指定目标 |
| `/knowledge <query>` | `commands/knowledge.md` | 查询/管理知识库 |

#### 8.4 新增 Hooks（2个）

| Hook | 触发点 | 脚本 | 说明 |
|------|--------|------|------|
| **research-detector** | UserPromptSubmit | `scripts/research-detector.sh` | 检测研究关键词，建议激活 |
| **auto-archive** | Stop | `scripts/auto-archive.sh` | 研究完成后自动归档 |

---

## 用例与工作流程

### 用例 1：Polymarket 赚钱策略研究

**用户输入**：
```
/deep-research 当下 Polymarket 上有哪些先端流行的赚钱策略？
```

**工作流程图**：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         /deep-research 启动                                  │
│                    默认激活: ultrawork + ralph-loop                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Phase 1: 问题拆解 (researcher + metis)                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  TodoWrite 创建子任务树:                                                     │
│  ├── 1. 了解 Polymarket 平台机制                                            │
│  ├── 2. 搜索主流交易策略                                                     │
│  ├── 3. 分析高收益用户案例                                                   │
│  ├── 4. 识别风险与合规问题                                                   │
│  └── 5. 综合生成策略报告                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Phase 2: 并行搜索 (crawler-coordinator + ultrawork)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ Exa 搜索     │  │ Twitter/X    │  │ Reddit       │  │ 学术论文     │    │
│  │ Polymarket   │  │ 策略讨论     │  │ r/polymarket │  │ 预测市场     │    │
│  │ strategies   │  │              │  │              │  │              │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
│         │                 │                 │                 │             │
│         └─────────────────┴─────────────────┴─────────────────┘             │
│                                    │                                         │
│                                    ▼                                         │
│                          ┌─────────────────┐                                │
│                          │   结果聚合池    │                                │
│                          └─────────────────┘                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Phase 3: 信息聚合 (knowledge-manager)                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                      │
│  │  去重处理   │ -> │  观点归类   │ -> │  可信度评估 │                      │
│  │  SimHash    │    │  策略分类   │    │  来源权重   │                      │
│  └─────────────┘    └─────────────┘    └─────────────┘                      │
│                                                                              │
│  输出: 结构化策略列表 + 元数据                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Phase 4: 深度分析 (oracle)                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  分析维度:                                                                   │
│  ├── 策略有效性评估                                                          │
│  ├── 风险收益比分析                                                          │
│  ├── 市场条件依赖性                                                          │
│  └── 合规与法律风险                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Phase 5: 报告生成 (document-writer)                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  输出: research/polymarket-strategies-2026-01-13.md                         │
│  ├── 执行摘要                                                                │
│  ├── 策略详解 (套利/做市/事件驱动/...)                                       │
│  ├── 风险提示                                                                │
│  ├── 参考来源                                                                │
│  └── 附录: 原始数据                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Phase 6: Oracle 验收 (ralph-loop 强制)                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  验收清单:                                                                   │
│  [x] 所有子任务 completed                                                    │
│  [x] 覆盖主流策略类型                                                        │
│  [x] 信息来源 ≥3 个                                                          │
│  [x] 风险提示完整                                                            │
│  [x] 报告结构清晰                                                            │
│                                                                              │
│  Oracle: APPROVED ✓                                                          │
│  输出: <promise>DONE</promise>                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 用例 2：竞品技术调研

**用户输入**：
```
/deep-research 对比分析 Cursor vs Windsurf vs Claude Code 的技术架构
```

**工作流程图**：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Phase 1: 问题拆解                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  子任务:                                                                     │
│  ├── 1.1 Cursor 架构分析                                                    │
│  ├── 1.2 Windsurf 架构分析                                                  │
│  ├── 1.3 Claude Code 架构分析                                               │
│  └── 1.4 对比矩阵生成                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Phase 2: 并行调研 (3个独立任务同时执行)                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                │
│  │ Task: Cursor    │ │ Task: Windsurf  │ │ Task: Claude    │                │
│  │                 │ │                 │ │ Code            │                │
│  │ - 官方文档      │ │ - 官方文档      │ │ - 官方文档      │                │
│  │ - GitHub 源码   │ │ - 技术博客      │ │ - SDK 文档      │                │
│  │ - 技术博客      │ │ - 用户评测      │ │ - 社区讨论      │                │
│  └────────┬────────┘ └────────┬────────┘ └────────┬────────┘                │
│           │                   │                   │                          │
│           └───────────────────┼───────────────────┘                          │
│                               ▼                                              │
│                    ┌─────────────────────┐                                  │
│                    │ 实体聚合: 按产品    │                                  │
│                    └─────────────────────┘                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Phase 3: 对比分析 (oracle)                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  对比维度:                                                                   │
│  ├── 核心架构 (LSP/AST/Agent)                                               │
│  ├── AI 集成方式                                                             │
│  ├── 扩展性设计                                                              │
│  ├── 性能表现                                                                │
│  └── 生态系统                                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Phase 4: 报告输出                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  research/ai-code-editors-comparison-2026-01-13.md                          │
│  ├── 对比矩阵表格                                                            │
│  ├── 各产品详细分析                                                          │
│  ├── 优劣势总结                                                              │
│  └── 选型建议                                                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 用例 3：快速模式 - 简单问题

**用户输入**：
```
/deep-research 2024年诺贝尔物理学奖得主是谁？ --quick
```

**工作流程图**：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  /deep-research --quick (禁用 ultrawork + ralph-loop)                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  单次搜索 (Exa web_search)                                                   │
│  → 直接返回结果，无需多轮迭代                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  简要回答 + 来源链接                                                         │
│  (无需 Oracle 验收，无需生成报告)                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 非功能需求

- **单一职责原则**：每个智能体专注单一职责（搜索/爬取/分析/存储）
- **模块化设计**：爬虫工具作为独立模块，可插拔替换
- **依赖管理**：通过 MCP 协议与外部工具解耦
- **清晰接口**：定义统一的数据格式（JSON/Markdown）

### 性能要求

- 多源搜索应支持并行执行，总耗时不超过单源的 1.5 倍
- 大型研究任务应支持增量处理，避免内存溢出
- 存储操作应异步执行，不阻塞主流程

### 安全要求

- 爬虫工具应遵守 robots.txt 和平台使用条款
- 敏感数据（API密钥、登录态）应安全存储
- 用户数据应本地优先，云同步需用户明确授权

### 可靠性要求

- 研究任务应支持断点续传
- 单个数据源失败不应影响整体流程
- 应有完善的错误处理和重试机制

### 易用性要求

- 命令语法应简洁直观
- 研究进度应实时反馈
- 报告格式应清晰易读，支持导出
